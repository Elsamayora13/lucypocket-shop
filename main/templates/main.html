{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Lucy Locket Shop</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="bg-gray-50 w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Latest Products</h1>
      <p class="text-gray-600">Discover the newest items from Lucy Locket Shop</p>
    </div>
    
    <button id="openModalBtn" class="inline-flex items-center px-4 py-2 bg-white text-purple-600 font-semibold outline outline-2 outline-purple-600 outline-offset-[-2px] rounded-md hover:bg-purple-600 hover:text-white transition-colors mb-4">
      Create Product by AJAX
    </button>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <button id="filter-all" class="bg-purple-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-purple-700">
          All Products
        </button>
        <button id="filter-my" class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-purple-600 hover:text-white">
          My Products
        </button>
      </div>
      {% if user.is_authenticated %}
        <div class="text-sm text-gray-500">
          Last login: {{ last_login }}
        </div>
      {% endif %}
    </div>

    <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% if not product_list %}
        <div class="col-span-full bg-white rounded-lg border border-gray-200 p-12 text-center">
          <div class="w-32 h-32 mx-auto mb-4">
            <img src="{% static 'image/no-product.png' %}" alt="No products available" class="w-full h-full object-contain">
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
          <p class="text-gray-500 mb-6">Be the first to add products to the shop.</p>
        </div>
      {% else %}
        {% for product in product_list %}
          <div class="product-card" data-category="{{ product.category|lower }}">
            {% include 'card_product.html' with product=product %}
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>
</div>

<div id="productModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-gray-900">Add New Product</h3>
      <button id="closeModalBtn" class="text-gray-400 hover:text-gray-500">
        <span class="text-2xl">&times;</span>
      </button>
    </div>
    
    <form id="productForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
        <input type="text" id="nameInput" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Price *</label>
        <input type="number" id="priceInput" required min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
        <textarea id="descInput" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
        <select id="categoryInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
          <option value="shoes">Shoes</option>
          <option value="ball">Ball</option>
          <option value="accessories">Accessories</option>
          <option value="training">Training</option>
          <option value="other" selected>Other</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
        <input type="number" id="stockInput" value="0" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Thumbnail URL</label>
        <input type="url" id="thumbnailInput" placeholder="https://example.com/image.jpg" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
        <input type="text" id="colorInput" placeholder="e.g., Red, Blue" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
      </div>
      
      <div class="flex items-center">
        <input type="checkbox" id="featuredInput" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
        <label for="featuredInput" class="ml-2 block text-sm text-gray-900">Featured Product</label>
      </div>
      
      <div class="flex gap-2 pt-4">
        <button type="button" id="cancelBtn" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">
          Cancel
        </button>
        <button type="submit" id="submitBtn" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
          Add Product
        </button>
      </div>
    </form>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  console.log('üü¢ Product AJAX Script starting...');

  const modal = document.getElementById('productModal');
  const form = document.getElementById('productForm');
  const openBtn = document.getElementById('openModalBtn');
  const closeBtn = document.getElementById('closeModalBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  
  let isSubmitting = false; // ‚úÖ Prevent double submit
  
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');

  openBtn.addEventListener('click', function() {
    modal.classList.remove('hidden');
    form.reset();
    isSubmitting = false; // Reset flag
  });

  closeBtn.addEventListener('click', function() {
    modal.classList.add('hidden');
  });

  cancelBtn.addEventListener('click', function() {
    modal.classList.add('hidden');
  });

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    e.stopPropagation(); // ‚úÖ Stop event bubbling
    e.stopImmediatePropagation(); // ‚úÖ Stop other handlers

    // ‚úÖ Prevent double submit
    if (isSubmitting) {
      console.log('‚ö†Ô∏è Already submitting, ignoring duplicate submit');
      return;
    }

    isSubmitting = true;

    const name = document.getElementById('nameInput').value.trim();
    const price = document.getElementById('priceInput').value.trim();
    const description = document.getElementById('descInput').value.trim();
    const category = document.getElementById('categoryInput').value;
    const stock = document.getElementById('stockInput').value || '0';
    const thumbnail = document.getElementById('thumbnailInput').value.trim();
    const color = document.getElementById('colorInput').value.trim();
    const is_featured = document.getElementById('featuredInput').checked;

    console.log('üì¶ Submitting product:', {name, price, description});

    if (!name || !price || !description) {
      alert('‚ùå Fill all required fields!');
      isSubmitting = false;
      return;
    }

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    const formData = new FormData();
    formData.append('name', name);
    formData.append('price', price);
    formData.append('description', description);
    formData.append('category', category);
    formData.append('stock', stock);
    if (thumbnail) formData.append('thumbnail', thumbnail);
    if (color) formData.append('color', color);
    if (is_featured) formData.append('is_featured', 'on');

    try {
      const response = await fetch("{% url 'main:add_product_entry_ajax' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: formData,
        credentials: 'include',
      });

      const text = await response.text();
      console.log('üì• Response:', response.status, text);

      if (response.ok) {
        console.log('‚úÖ Product added successfully!');
        modal.classList.add('hidden');
        // ‚úÖ Wait a bit before reload to ensure server processed
        setTimeout(() => {
          location.reload();
        }, 300);
      } else {
        alert("‚ùå Failed: " + text);
        isSubmitting = false;
      }
    } catch(err) {
      console.error('‚ùå Error:', err);
      alert("‚ùå " + err.message);
      isSubmitting = false;
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Add Product";
    }
  });

  console.log('‚úÖ Product AJAX Script loaded!');
})();
</script>

{% endblock content %}